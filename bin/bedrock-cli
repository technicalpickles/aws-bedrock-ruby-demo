#!/usr/bin/env ruby

require 'bundler/setup'
require 'thor'
require 'aws-sdk-bedrockruntime'
require 'json'

class BedrockCLI < Thor
  desc "hello", "Test Bedrock connection with a simple completion"
  def hello
    client = Aws::BedrockRuntime::Client.new
    
    # Using Claude model
    request = {
      model_id: "anthropic.claude-3-sonnet-20240229-v1:0",
      content_type: "application/json",
      accept: "application/json",
      body: {
        anthropic_version: "bedrock-2023-05-31",
        max_tokens: 100,
        messages: [
          {
            role: "user",
            content: "Say hello world!"
          }
        ]
      }.to_json
    }

    begin
      response = client.invoke_model_with_response_stream(request)
      response.body.each do |event|
        chunk = JSON.parse(event.bytes)
        if chunk["type"] == "content_block_delta"
          print chunk["delta"]["text"]
        end
      end
      puts # Add newline at the end
    rescue Aws::BedrockRuntime::Errors::ServiceError => e
      puts "Error: #{e.message}"
    end
  end
end

BedrockCLI.start(ARGV) 